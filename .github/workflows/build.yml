name: Build Rime with copilot plugin

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

env:
  CMAKE_GENERATOR: Ninja

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Rime (main repository)
        uses: actions/checkout@v4
        with:
          repository: rime/librime
          path: librime-root
          submodules: recursive
          fetch-depth: 0

      - name: Checkout Copilot Plugin (this repository)
        uses: actions/checkout@v4
        with:
          path: librime-root/plugins/librime-copilot
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies
        uses: crazy-max/ghaction-chocolatey@v2
        with:
          args: install cmake ninja -y

      - name: Setup Vcpkg
        shell: powershell
        run: |
          git clone https://github.com/microsoft/vcpkg.git $env:GITHUB_WORKSPACE/vcpkg
          & "$env:GITHUB_WORKSPACE/vcpkg/bootstrap-vcpkg.bat"
          echo "$env:GITHUB_WORKSPACE/vcpkg" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Cache Vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg/installed
            ${{ github.workspace }}/vcpkg/downloads
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json', '**/.github/workflows/build.yml') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Install Dependencies via Vcpkg
        shell: powershell
        working-directory: ${{ github.workspace }}/vcpkg
        run: |
          .\vcpkg install boost:x64-windows glog:x64-windows yaml-cpp:x64-windows leveldb:x64-windows marisa-trie:x64-windows opencc:x64-windows gtest:x64-windows --allow-unsupported

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Create MSVC Shim Header with Inline Boost Fix
        shell: powershell
        working-directory: ${{ github.workspace }}/librime-root
        run: |
          $shimContent = "#define __attribute__(x)`n`n`n`n// Inline boost::throw_exception to fix all modules`n`n`nstatic inline void boost::throw_exception(std::exception const& e) { std::terminate(); }"
          Set-Content -Path "msvc_shim.h" -Value $shimContent -Encoding ASCII
          Write-Host "✅ Created msvc_shim.h with inline boost fix"

      - name: Patch Sources
        shell: bash
        working-directory: ${{ github.workspace }}/librime-root
        run: |
          # 修复 dl 库依赖
          sed -i 's/set(rime_optional_deps ${rime_optional_deps} dl)/if(NOT WIN32)\n  set(rime_optional_deps ${rime_optional_deps} dl)\nendif()/' src/CMakeLists.txt
          
          # 【关键】直接屏蔽 setup.cc 中的 GLog Flags，解决符号链接错误
          sed -i 's/FLAGS_log_dir/\/\/ FLAGS_log_dir/g' src/rime/setup.cc
          sed -i 's/FLAGS_minloglevel/\/\/ FLAGS_minloglevel/g' src/rime/setup.cc
          sed -i 's/FLAGS_logfile_mode/\/\/ FLAGS_logfile_mode/g' src/rime/setup.cc
          
          echo "✅ Patched CMakeLists.txt and setup.cc"

      - name: Configure CMake
        shell: powershell
        working-directory: ${{ github.workspace }}/librime-root
        env:
          CL: /FI"${{ github.workspace }}/librime-root/msvc_shim.h"
        run: |
          $env:VCPKG_ROOT="${{ github.workspace }}/vcpkg"
          cmake -G Ninja -DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL `
            -DBUILD_SHARED_LIBS=ON -DBUILD_SEPARATE_LIBS=ON -DENABLE_EXTERNAL_PLUGINS=ON `
            -DBUILD_TEST=OFF -DENABLE_TESTS=OFF -DBUILD_GMOCK=OFF `
            -DCMAKE_CXX_FLAGS="/DGLOG_NO_ABBREVIATED_SEVERITIES /DWIN32_LEAN_AND_MEAN /DNOMINMAX /MD" `
            -DCMAKE_CXX_FLAGS_RELEASE="/MD /O2 /Ob2 /DNDEBUG" `
            -DCMAKE_CXX_FLAGS_DEBUG="/MDd /Zi /Ob0 /Od /RTC1" `
            -B build

      - name: Build
        shell: powershell
        working-directory: ${{ github.workspace }}/librime-root
        env:
          CL: /FI"${{ github.workspace }}/librime-root/msvc_shim.h"
        run: |
          cmake --build build --config Release

      - name: Upload Rime DLL
        uses: actions/upload-artifact@v4
        with:
          name: rime-dll
          path: ${{ github.workspace }}/librime-root/build/Release/rime.dll

      - name: Upload Copilot Plugin
        uses: actions/upload-artifact@v4
        with:
          name: librime-copilot
          path: |
            ${{ github.workspace }}/librime-root/build/Release/librime-copilot.dll
            ${{ github.workspace }}/librime-root/build/Release/rime.dll

      - name: Upload All LIB Files
        uses: actions/upload-artifact@v4
        with:
          name: lib-files
          path: ${{ github.workspace }}/librime-root/build/Release/*.lib
